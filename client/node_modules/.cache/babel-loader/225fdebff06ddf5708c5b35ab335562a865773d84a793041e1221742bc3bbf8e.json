{"ast":null,"code":"import React,{useEffect,useState,useRef}from'react';import io from'socket.io-client';import'./ChatModal.css';import{jsxs as _jsxs,jsx as _jsx}from\"react/jsx-runtime\";const SOCKET_SERVER_URL=\"http://localhost:5000\";function ChatModal(_ref){let{show,onClose,order,currentUser,onMarkAsRead}=_ref;const[socket,setSocket]=useState(null);const[messages,setMessages]=useState([]);const[newMessage,setNewMessage]=useState('');const[loading,setLoading]=useState(false);const messagesEndRef=useRef(null);const markMessagesAsRead=async()=>{if(!order||!onMarkAsRead)return;try{const token=localStorage.getItem('token');await fetch(\"http://localhost:5000/api/chat/read/\".concat(order.id),{method:'PUT',headers:{'Authorization':\"Bearer \".concat(token)}});onMarkAsRead(order.id);}catch(err){console.error(\"Failed to mark messages as read\",err);}};useEffect(()=>{if(show&&order){const newSocket=io(SOCKET_SERVER_URL);setSocket(newSocket);newSocket.emit('join_room',order.id);fetchMessageHistory();markMessagesAsRead();newSocket.on('receive_message',data=>{setMessages(prev=>[...prev,data]);// Also mark as read if modal is open when message arrives\nmarkMessagesAsRead();});return()=>{newSocket.disconnect();};}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[show,order]);useEffect(()=>{var _messagesEndRef$curre;(_messagesEndRef$curre=messagesEndRef.current)===null||_messagesEndRef$curre===void 0?void 0:_messagesEndRef$curre.scrollIntoView({behavior:\"smooth\"});},[messages]);const fetchMessageHistory=async()=>{setLoading(true);try{const token=localStorage.getItem('token');const res=await fetch(\"http://localhost:5000/api/chat/\".concat(order.id),{headers:{'Authorization':\"Bearer \".concat(token)}});const data=await res.json();if(data.success){setMessages(data.messages);}}catch(err){console.error(\"Failed to fetch message history\",err);}setLoading(false);};const handleSendMessage=async e=>{e.preventDefault();if(!newMessage.trim()||!socket)return;const messageData={room:order.id,sender_id:currentUser.id,sender_name:currentUser.name,message:newMessage,sent_at:new Date().toISOString()};socket.emit('send_message',messageData);try{const token=localStorage.getItem('token');await fetch('http://localhost:5000/api/chat',{method:'POST',headers:{'Content-Type':'application/json','Authorization':\"Bearer \".concat(token)},body:JSON.stringify({orderId:order.id,message:newMessage})});}catch(err){console.error(\"Failed to save message\",err);}setMessages(prev=>[...prev,messageData]);setNewMessage('');};if(!show)return null;return/*#__PURE__*/_jsx(\"div\",{className:\"chat-modal-backdrop\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"chat-modal-container\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"chat-modal-header\",children:[/*#__PURE__*/_jsxs(\"h5\",{children:[\"Chat for Order: \",order.product_name]}),/*#__PURE__*/_jsx(\"button\",{onClick:onClose,className:\"btn-close\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"chat-modal-body\",children:[loading?/*#__PURE__*/_jsx(\"div\",{className:\"text-center\",children:\"Loading messages...\"}):messages.map((msg,index)=>/*#__PURE__*/_jsxs(\"div\",{className:\"message \".concat(msg.sender_id===currentUser.id?'sent':'received'),children:[/*#__PURE__*/_jsx(\"div\",{className:\"message-sender\",children:msg.sender_id===currentUser.id?\"You\":msg.sender_name}),/*#__PURE__*/_jsx(\"div\",{className:\"message-content\",children:msg.message}),/*#__PURE__*/_jsx(\"div\",{className:\"message-time\",children:new Date(msg.sent_at).toLocaleTimeString()})]},index)),/*#__PURE__*/_jsx(\"div\",{ref:messagesEndRef})]}),/*#__PURE__*/_jsx(\"div\",{className:\"chat-modal-footer\",children:/*#__PURE__*/_jsxs(\"form\",{onSubmit:handleSendMessage,className:\"d-flex\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",className:\"form-control\",placeholder:\"Type a message...\",value:newMessage,onChange:e=>setNewMessage(e.target.value)}),/*#__PURE__*/_jsx(\"button\",{type:\"submit\",className:\"btn eco-btn ms-2\",children:\"Send\"})]})})]})});}export default ChatModal;","map":{"version":3,"names":["React","useEffect","useState","useRef","io","jsxs","_jsxs","jsx","_jsx","SOCKET_SERVER_URL","ChatModal","_ref","show","onClose","order","currentUser","onMarkAsRead","socket","setSocket","messages","setMessages","newMessage","setNewMessage","loading","setLoading","messagesEndRef","markMessagesAsRead","token","localStorage","getItem","fetch","concat","id","method","headers","err","console","error","newSocket","emit","fetchMessageHistory","on","data","prev","disconnect","_messagesEndRef$curre","current","scrollIntoView","behavior","res","json","success","handleSendMessage","e","preventDefault","trim","messageData","room","sender_id","sender_name","name","message","sent_at","Date","toISOString","body","JSON","stringify","orderId","className","children","product_name","onClick","map","msg","index","toLocaleTimeString","ref","onSubmit","type","placeholder","value","onChange","target"],"sources":["C:/Users/Devi Sri Prasad/Desktop/Farmaconnect/client/src/ChatModal.js"],"sourcesContent":["import React, { useEffect, useState, useRef } from 'react';\nimport io from 'socket.io-client';\nimport './ChatModal.css';\n\nconst SOCKET_SERVER_URL = \"http://localhost:5000\";\n\nfunction ChatModal({ show, onClose, order, currentUser, onMarkAsRead }) {\n  const [socket, setSocket] = useState(null);\n  const [messages, setMessages] = useState([]);\n  const [newMessage, setNewMessage] = useState('');\n  const [loading, setLoading] = useState(false);\n  const messagesEndRef = useRef(null);\n\n  const markMessagesAsRead = async () => {\n    if (!order || !onMarkAsRead) return;\n    try {\n      const token = localStorage.getItem('token');\n      await fetch(`http://localhost:5000/api/chat/read/${order.id}`, {\n        method: 'PUT',\n        headers: { 'Authorization': `Bearer ${token}` }\n      });\n      onMarkAsRead(order.id);\n    } catch (err) {\n      console.error(\"Failed to mark messages as read\", err);\n    }\n  };\n\n  useEffect(() => {\n    if (show && order) {\n      const newSocket = io(SOCKET_SERVER_URL);\n      setSocket(newSocket);\n      newSocket.emit('join_room', order.id);\n      \n      fetchMessageHistory();\n      markMessagesAsRead();\n\n      newSocket.on('receive_message', (data) => {\n        setMessages(prev => [...prev, data]);\n        // Also mark as read if modal is open when message arrives\n        markMessagesAsRead();\n      });\n\n      return () => {\n        newSocket.disconnect();\n      };\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [show, order]);\n\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  }, [messages]);\n\n  const fetchMessageHistory = async () => {\n    setLoading(true);\n    try {\n      const token = localStorage.getItem('token');\n      const res = await fetch(`http://localhost:5000/api/chat/${order.id}`, {\n        headers: { 'Authorization': `Bearer ${token}` }\n      });\n      const data = await res.json();\n      if (data.success) {\n        setMessages(data.messages);\n      }\n    } catch (err) {\n      console.error(\"Failed to fetch message history\", err);\n    }\n    setLoading(false);\n  };\n\n  const handleSendMessage = async (e) => {\n    e.preventDefault();\n    if (!newMessage.trim() || !socket) return;\n\n    const messageData = {\n      room: order.id,\n      sender_id: currentUser.id,\n      sender_name: currentUser.name,\n      message: newMessage,\n      sent_at: new Date().toISOString(),\n    };\n\n    socket.emit('send_message', messageData);\n\n    try {\n      const token = localStorage.getItem('token');\n      await fetch('http://localhost:5000/api/chat', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`,\n        },\n        body: JSON.stringify({ orderId: order.id, message: newMessage }),\n      });\n    } catch (err) {\n      console.error(\"Failed to save message\", err);\n    }\n    \n    setMessages(prev => [...prev, messageData]);\n    setNewMessage('');\n  };\n  \n  if (!show) return null;\n\n  return (\n    <div className=\"chat-modal-backdrop\">\n      <div className=\"chat-modal-container\">\n        <div className=\"chat-modal-header\">\n          <h5>Chat for Order: {order.product_name}</h5>\n          <button onClick={onClose} className=\"btn-close\"></button>\n        </div>\n        <div className=\"chat-modal-body\">\n          {loading ? (\n            <div className=\"text-center\">Loading messages...</div>\n          ) : (\n            messages.map((msg, index) => (\n              <div key={index} className={`message ${msg.sender_id === currentUser.id ? 'sent' : 'received'}`}>\n                <div className=\"message-sender\">{msg.sender_id === currentUser.id ? \"You\" : msg.sender_name}</div>\n                <div className=\"message-content\">{msg.message}</div>\n                <div className=\"message-time\">{new Date(msg.sent_at).toLocaleTimeString()}</div>\n              </div>\n            ))\n          )}\n          <div ref={messagesEndRef} />\n        </div>\n        <div className=\"chat-modal-footer\">\n          <form onSubmit={handleSendMessage} className=\"d-flex\">\n            <input\n              type=\"text\"\n              className=\"form-control\"\n              placeholder=\"Type a message...\"\n              value={newMessage}\n              onChange={(e) => setNewMessage(e.target.value)}\n            />\n            <button type=\"submit\" className=\"btn eco-btn ms-2\">Send</button>\n          </form>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default ChatModal; "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}